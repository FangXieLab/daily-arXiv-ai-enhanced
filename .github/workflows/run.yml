name: arXiv-daily-ai-enhanced

on:
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»æœ‰å†™å…¥æƒé™ï¼

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # ========== å…³é”®ä¿®å¤ï¼šåˆ›å»ºæ–‡ä»¶å¤¹ç»“æ„ ==========
    - name: Create directory structure
      run: |
        echo "ğŸ”§ åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„..."
        
        # å¼ºåˆ¶åˆ›å»ºæ‰€æœ‰éœ€è¦çš„ç›®å½•
        mkdir -p data
        mkdir -p assets
        mkdir -p js
        
        # åˆ›å»º .nojekyll æ–‡ä»¶ï¼ˆGitHub Pageséœ€è¦ï¼‰
        touch .nojekyll
        
        # æ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸ
        echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
        ls -la
        echo "ğŸ“ dataæ–‡ä»¶å¤¹å†…å®¹:"
        ls -la data/ || echo "dataæ–‡ä»¶å¤¹ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
        
        # åˆ›å»ºåˆå§‹æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "index.html" ]; then
          echo "ğŸ“„ åˆ›å»ºindex.html..."
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>arXiv Daily</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>arXiv Daily AI Enhanced</h1>
    <p>æ•°æ®æ­£åœ¨æ›´æ–°ä¸­ï¼Œè¯·ç¨ååˆ·æ–°...</p>
</body>
</html>
EOF
        fi
        
        # åˆ›å»ºåˆå§‹æ–‡ä»¶åˆ—è¡¨
        echo "# arXivæ•°æ®æ–‡ä»¶åˆ—è¡¨" > assets/file-list.txt
        echo "# è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹" >> assets/file-list.txt
        
        echo "âœ… ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"
    
    # ========== å®‰è£…ä¾èµ– ==========
    - name: Install dependencies
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv sync
    
    # ========== çˆ¬å–æ•°æ® ==========
    - name: Crawl arXiv papers
      id: crawl_step
      run: |
        source .venv/bin/activate
        today=$(date -u "+%Y-%m-%d")
        echo "ğŸ“¥ å¼€å§‹çˆ¬å– $today çš„arXivè®ºæ–‡..."
        
        # ç¡®ä¿åœ¨daily_arxivç›®å½•ä¸­æ‰§è¡Œ
        cd daily_arxiv
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export TOKEN_GITHUB=${{ secrets.TOKEN_GITHUB }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export CATEGORIES="${{ vars.CATEGORIES }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"
        
        # çˆ¬å–æ•°æ®ï¼Œè¾“å‡ºåˆ°ä¸Šçº§ç›®å½•çš„dataæ–‡ä»¶å¤¹
        echo "ğŸ•¸ï¸ æ‰§è¡ŒScrapyçˆ¬å–..."
        scrapy crawl arxiv -o ../data/${today}.jsonl
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆæ–‡ä»¶
        if [ ! -f "../data/${today}.jsonl" ]; then
            echo "âŒ çˆ¬å–å¤±è´¥ï¼šæœªç”Ÿæˆæ•°æ®æ–‡ä»¶"
            exit 1
        fi
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        echo "âœ… çˆ¬å–æˆåŠŸï¼"
        echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -l <../data/${today}.jsonl) è¡Œ"
        echo "ğŸ“ æ–‡ä»¶ä½ç½®: ../data/${today}.jsonl"
        
        echo "crawl_date=$today" >> $GITHUB_OUTPUT
    
    # ========== æ›´æ–°æ–‡ä»¶åˆ—è¡¨ ==========
    - name: Update file list
      run: |
        echo "ğŸ“‹ æ›´æ–°æ–‡ä»¶åˆ—è¡¨..."
        today=${{ steps.crawl_step.outputs.crawl_date }}
        
        # ç¡®ä¿assetsç›®å½•å­˜åœ¨
        mkdir -p assets
        
        # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
        ls data/*.jsonl 2>/dev/null | sed 's|data/||' > assets/file-list.txt
        
        # å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œåˆ›å»ºç©ºçš„åˆ—è¡¨
        if [ ! -s "assets/file-list.txt" ]; then
            echo "# æš‚æ— æ•°æ®æ–‡ä»¶" > assets/file-list.txt
            echo "${today}.jsonl" >> assets/file-list.txt
        fi
        
        echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨å†…å®¹:"
        cat assets/file-list.txt
        
        echo "âœ… æ–‡ä»¶åˆ—è¡¨æ›´æ–°å®Œæˆ"
    
    # ========== å…³é”®ï¼šæäº¤å’Œæ¨é€æ›´æ”¹ ==========
    - name: Commit and push changes
      run: |
        echo "ğŸ“¤ æäº¤æ›´æ”¹åˆ°GitHubä»“åº“..."
        
        # é…ç½®gitç”¨æˆ·
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # æ˜¾ç¤ºå°†è¦æäº¤çš„æ–‡ä»¶
        echo "ğŸ“ å°†è¦æäº¤çš„æ–‡ä»¶:"
        git status
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --cached --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        else
            # æäº¤æ›´æ”¹
            today=${{ steps.crawl_step.outputs.crawl_date }}
            git commit -m "ğŸ“š Auto-update: arXiv papers for $today [skip ci]"
            echo "âœ… æ›´æ”¹å·²æäº¤"
            
            # æ¨é€æ›´æ”¹
            echo "ğŸ”„ æ¨é€åˆ°ä»“åº“..."
            git push origin main
            echo "âœ… æ¨é€å®Œæˆ"
        fi
    
    # ========== éªŒè¯ç»“æœ ==========
    - name: Verify deployment
      run: |
        echo "ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
        echo ""
        echo "ğŸ“Š ç»“æœæ‘˜è¦:"
        echo "  âœ… æ•°æ®çˆ¬å–å®Œæˆ"
        echo "  âœ… æ–‡ä»¶åˆ—è¡¨æ›´æ–°"
        echo "  âœ… æ›´æ”¹å·²æäº¤åˆ°ä»“åº“"
        echo ""
        echo "ğŸŒ ç½‘ç«™åœ°å€: https://fangxielab.github.io/daily-arXiv-ai-enhanced/"
        echo ""
        echo "ğŸ“ æ³¨æ„:"
        echo "  â€¢ GitHub Pages å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ¥æ›´æ–°"
        echo "  â€¢ åˆ·æ–°ç½‘ç«™æŸ¥çœ‹æœ€æ–°æ•°æ®"
